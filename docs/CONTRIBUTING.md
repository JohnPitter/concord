# Contributing to Concord

Thank you for your interest in contributing to Concord. This guide covers everything you need to get started.

---

## Table of Contents

- [Prerequisites](#prerequisites)
- [Project Setup](#project-setup)
- [Development Workflow](#development-workflow)
- [Build Commands](#build-commands)
- [Testing](#testing)
- [Code Style](#code-style)
- [Architecture Overview](#architecture-overview)
- [Pull Request Process](#pull-request-process)
- [Important Constraints](#important-constraints)

---

## Prerequisites

| Tool | Version | Purpose |
|---|---|---|
| [Go](https://go.dev/dl/) | 1.24+ | Backend, services, P2P |
| [Node.js](https://nodejs.org/) | 18+ | Frontend build tooling |
| [Wails](https://wails.io/) | v2 | Desktop app framework |
| [Git](https://git-scm.com/) | latest | Version control |

### Install Wails

```bash
go install github.com/wailsapp/wails/v2/cmd/wails@latest
```

Verify:

```bash
wails doctor
```

This checks that all system dependencies (OS webview, build tools) are installed.

---

## Project Setup

### 1. Clone the repository

```bash
git clone https://github.com/concord-chat/concord.git
cd concord
```

### 2. Install Go dependencies

```bash
go mod download && go mod tidy
```

### 3. Install frontend dependencies

```bash
cd frontend && npm install && cd ..
```

### 4. Run in development mode

```bash
wails dev
```

This starts the Wails dev server with hot reload. The frontend is available at `http://localhost:5173`, but you should interact through the native window.

> **IMPORTANT:** Always run via `wails dev`. Running `npm run dev` alone will fail because the Wails runtime (`window.go`) is only available when running through Wails. The TypeScript bindings in `frontend/wailsjs/` are generated by Wails and require the Wails runtime.

---

## Development Workflow

### Directory Structure

```
concord/
  main.go                     # Desktop app entry point (Wails v2)
  cmd/server/main.go          # Central server entry point
  internal/
    auth/                     # GitHub OAuth, JWT, sessions
    cache/                    # LRU in-memory cache
    chat/                     # Text chat, messages, FTS5
    config/                   # Configuration management
    files/                    # File sharing, chunking, scanning
    network/
      p2p/                    # libp2p host, discovery
      signaling/              # WebSocket signaling server/client
    observability/            # Logger, metrics, health checks
    security/                 # Crypto, rate limiting, sanitization, validation
    server/                   # Server/channel/member management, RBAC
    store/
      sqlite/                 # SQLite connection, migrations
      postgres/               # PostgreSQL (planned for central server)
      redis/                  # Redis (planned for central server)
    translation/              # Voice translation pipeline
    voice/                    # Voice chat engine, codec, mixer, VAD
  pkg/
    crypto/                   # E2EE (X25519 + AES-256-GCM)
    protocol/                 # Wire protocol (msgpack)
    version/                  # Build version info
  frontend/
    src/
      lib/
        components/
          ui/                 # Reusable UI components
          auth/               # Auth components
          layout/             # Layout components
        stores/               # Svelte 5 rune-based stores
      assets/                 # Static assets (SVG, images)
    wailsjs/                  # Auto-generated Wails bindings (do not edit)
  docs/                       # Documentation
  deployments/                # Docker, deployment configs
```

### Wails Bindings

Wails generates TypeScript bindings from the Go `App` struct methods. When you add or modify methods on the `App` struct in `main.go`:

```bash
wails generate module
```

This regenerates `frontend/wailsjs/go/main/App.ts`. The frontend imports from this file:

```typescript
import * as App from '../../../wailsjs/go/main/App';
```

Never use `window.go.main.App` directly.

### Frontend Stack

- **Svelte 5** with runes syntax (`$props`, `$state`, `$derived`, `$effect`)
- **TypeScript** for type safety
- **TailwindCSS v4** for styling (dark-first "Void" design system)
- **Vite** for development and bundling

### Environment Variables

| Variable | Default | Description |
|---|---|---|
| `CONCORD_ENV` | `dev` | Environment (dev/staging/production) |
| `CONCORD_DATA_DIR` | OS-specific | Data directory |
| `CONCORD_DB_PATH` | (auto) | SQLite database path |
| `LOG_LEVEL` | `info` | Logging level |

---

## Build Commands

### Development

```bash
# Start dev server with hot reload
wails dev

# Alternative (via Makefile)
make dev
```

### Production Build

```bash
# Build desktop app (with UPX compression)
wails build -clean -upx

# Alternative (via Makefile)
make build
```

### Central Server

```bash
# Build central server (no CGo needed)
make build-server
```

### Generate Bindings

```bash
# Regenerate TypeScript bindings after changing Go App methods
wails generate module
```

---

## Testing

### Running Tests

```bash
# All Go tests with race detection and coverage
go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

# Unit tests only (short mode)
go test -v -short -race ./...

# Integration tests only
go test -v -run Integration ./...

# Single package
go test -v ./internal/store/sqlite/...
go test -v ./internal/auth/...
go test -v ./internal/voice/...

# Coverage report
make test-coverage
```

### Test Conventions

- Use [testify](https://github.com/stretchr/testify) for assertions (`assert`, `require`)
- Integration tests have the prefix `Integration` in their function name
- Test files follow the `_test.go` naming convention
- Target test distribution: 60% unit, 30% integration, 10% E2E

### Writing Tests

```go
func TestServiceMethod(t *testing.T) {
    // Arrange
    svc := NewService(...)

    // Act
    result, err := svc.Method(ctx, ...)

    // Assert
    require.NoError(t, err)
    assert.Equal(t, expected, result)
}

func TestIntegrationServiceFlow(t *testing.T) {
    if testing.Short() {
        t.Skip("skipping integration test in short mode")
    }
    // ... integration test with real DB
}
```

---

## Code Style

### Go

```bash
# Format code
gofmt -s -w $(find . -type f -name '*.go' -not -path "./vendor/*")

# Fix imports
goimports -w $(find . -type f -name '*.go' -not -path "./vendor/*")

# Lint
golangci-lint run ./...

# Vet
go vet ./...

# Vulnerability check
govulncheck ./...
```

### Key Conventions

- **Clean Architecture**: Dependencies flow inward. Domain has no external deps.
- **Structured logging**: Use zerolog with context fields. Never log secrets.
- **Error wrapping**: Use `fmt.Errorf("context: %w", err)` for all errors.
- **Big O annotation**: Document algorithmic complexity in comments.
- **No unused imports**: Code must compile without dead imports.
- **Context propagation**: Pass `context.Context` through all service methods.

### Frontend

- Svelte 5 runes syntax (not legacy stores)
- TailwindCSS v4 utilities
- Never add `* { padding: 0; margin: 0 }` in global CSS (breaks Tailwind)

---

## Architecture Overview

Concord follows Clean Architecture with four layers:

```
+------------------------------------------+
|          Presentation Layer              |
|   Wails Bindings + Svelte UI            |
+------------------------------------------+
|          Application Layer               |
|   Services (auth, server, chat, etc.)   |
+------------------------------------------+
|          Domain Layer                    |
|   Models + Interfaces (zero deps)       |
+------------------------------------------+
|          Infrastructure Layer            |
|   SQLite, HTTP, P2P, WebSocket          |
+------------------------------------------+
```

**Dependency rule:** Dependencies always point inward. The domain layer has zero external dependencies. Application services depend only on interfaces defined in the domain.

### Entry Points

| Entry | File | Description |
|---|---|---|
| Desktop App | `main.go` (root) | Wails v2 app. Must be at root due to Wails constraint. |
| Central Server | `cmd/server/main.go` | PostgreSQL + REST API (stub, planned). |

### Key Technologies

| Layer | Technology |
|---|---|
| Desktop framework | Wails v2 (OS webview, not Electron) |
| Database (client) | SQLite via `modernc.org/sqlite` (pure Go, no CGo) |
| Database (server) | PostgreSQL (planned) |
| P2P networking | libp2p (QUIC + TCP, Noise, mDNS, DHT) |
| Voice | Pion WebRTC v4 (Opus codec) |
| Signaling | gorilla/websocket |
| Observability | zerolog + Prometheus |
| Frontend | Svelte 5 + TypeScript + TailwindCSS v4 + Vite |

---

## Pull Request Process

### Before Submitting

1. **Code compiles**: Run `go build ./...` and `go vet ./...`
2. **Tests pass**: Run `go test -race ./...`
3. **No lint errors**: Run `golangci-lint run ./...`
4. **No unused imports**: Remove all dead imports
5. **CHANGELOG updated**: Add your changes following [Keep a Changelog](https://keepachangelog.com/) format
6. **Commit messages**: Use conventional commit format (`feat:`, `fix:`, `refactor:`, etc.)

### PR Template

```markdown
## Summary
Brief description of changes.

## Type
- [ ] Feature
- [ ] Bug fix
- [ ] Refactor
- [ ] Documentation
- [ ] Test

## Changes
- List specific changes

## Testing
- How was this tested?
- New tests added?

## CHANGELOG
- [ ] Updated CHANGELOG.md
```

### Review Checklist

- Follows Clean Architecture (no layer violations)
- Security principles applied (input validation, sanitization)
- Errors are wrapped with context
- Structured logging added for new flows
- Big O complexity documented for algorithms
- Tests cover the happy path and key error cases

---

## Important Constraints

### Wails v2

- `main.go` **must** be at the project root. Wails v2 does not support main in subdirectories.
- Always run the app via `wails dev`, never `npm run dev` alone.
- Frontend TypeScript config must include `wailsjs/**/*.ts` in its `include` array.
- Bindings are generated to `frontend/wailsjs/go/main/App.ts`.

### Database

- Client uses SQLite (pure Go via `modernc.org/sqlite`, no CGo required)
- Migrations run automatically on startup via `sqlite.Migrator`
- WAL mode and foreign keys are enabled by default

### Config Priority

Environment variables override config file values, which override defaults:

```
env vars > config.json > defaults
```

### Phased Development

Development follows the phased plan in `ARCHITECTURE.md` Section 14. Check the current phase status in `CHANGELOG.md` before starting work.

**Completed phases:** 1 (Foundation), 1.2 (Wails), 1.6 (Observability), 2 (Auth), 3 (Server Management), 4 (Text Chat), 5 (P2P Networking), 6 (Voice Chat), 7 (File Sharing), 8 (Translation), 9 (Central Server), 10 (Polish)
